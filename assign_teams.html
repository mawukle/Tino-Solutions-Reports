<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assign Teams to Clients</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
</head>
<body>
    <div class="container">
        <img src="logo.png" alt="Logo" class="logo">
        <a href="index" class="back-link">The Renewable Energy Experts</a>
        <h1>TEAM ASSIGNMENT</h1>

        <form id="assign_teams_form" action="{{ url_for('assign_teams') }}" method="POST">
            <!-- Date Filter -->
            <div id="date_filter">
              <label for="date">Date:</label>
              <input type="text" id="date" name="date_display" placeholder="Select a date" required readonly value="{{ selected_date }}"><br><br>
              <input type="hidden" id="date_hidden" name="date" value="{{ selected_date }}">
            </div>

            <!-- Client-Team Assignments -->
            <div id="client_team_container">
                {% if data_to_display %}
                    {% set client_team_counter = 1 %}
                    {% for data in data_to_display %}
                        <div class="client-team">
                            <div id="client_filter">
                                <label for="client_{{ client_team_counter }}">Client:</label>
                                <input type="text" id="client_{{ client_team_counter }}" name="client_{{ client_team_counter }}" value="{{ data.client_name }}" class="client-select" required>
                            </div>
                            <div id="location_filter">
                                <label for="location_{{ client_team_counter }}">Location:</label>
                                <input type="text" id="location_{{ client_team_counter }}" name="location_{{ client_team_counter }}" value="{{ data.location }}" readonly>
                            </div>
                            <div id="phone_number_filter">
                                <label for="phone_{{ client_team_counter }}">Phone Number:</label>
                                <input type="text" id="phone_{{ client_team_counter }}" name="phone_{{ client_team_counter }}" value="{{ data.phone_number }}" readonly>
                            </div>
                            <div id="team_filter">
                                <label for="team_{{ client_team_counter }}">Team:</label>
                                <input type="text" id="team_{{ client_team_counter }}" name="team_{{ client_team_counter }}" value="{{ data.assigned_team }}" class="team-select" required><br><br>
                            </div><br><br>
                        </div>
                        {% set client_team_counter = client_team_counter + 1 %}
                    {% endfor %}
                {% endif %}
            </div>

            <!-- Add New Client-Team -->
            <button type="button" id="add_client_team_button">Add Another Client and Team</button><br><br>

            <!-- Submit Button -->
            <button type="submit" class="submit-button">Submit</button>
        </form>
    </div>

    <script>
        let clientCounter = {{ client_team_counter or 0 }};  // Start from the current number of clients

        // Autocomplete for existing clients and teams
        {% for data in data_to_display %}
            activateAutocomplete('#client_{{ loop.index }}', 'client');
            activateTeamAutocomplete('#team_{{ loop.index }}');
        {% endfor %}

        // Autocomplete for new clients and teams
        $('#add_client_team_button').click(function() {
            clientCounter++;  // Increment counter

            const newClientTeam = `
                <div class="client-team">
                  <div id="client_filter">
                    <label for="client_${clientCounter}">Client ${clientCounter}:</label>
                    <input type="text" id="client_${clientCounter}" name="client_${clientCounter}" class="client-select" required>
                  </div>
                  <div id="client_filter">
                    <label for="location_${clientCounter}">Location:</label>
                    <input type="text" id="location_${clientCounter}" name="location_${clientCounter}" readonly>
                  </div>
                  <div id="client_filter">
                    <label for="phone_${clientCounter}">Phone Number:</label>
                    <input type="text" id="phone_${clientCounter}" name="phone_${clientCounter}" readonly>
                  </div>
                  <div id="team_filter">
                    <label for="team_${clientCounter}">Team ${clientCounter}:</label>
                    <input type="text" id="team_${clientCounter}" name="team_${clientCounter}" class="team-select" required><br><br>
                  </div><br><br>
                </div>`;

            $('#client_team_container').append(newClientTeam);

            // Activate autocomplete for the new client and team fields
            activateAutocomplete(`#client_${clientCounter}`, 'client');
            activateTeamAutocomplete(`#team_${clientCounter}`);
        });

        // Autocomplete function for clients
        function activateAutocomplete(selector, type) {
            $(selector).autocomplete({
                source: "{{ url_for('autocomplete_client') }}",
                select: function(event, ui) {
                    const clientName = ui.item.value;
                    const clientIndex = selector.split('_')[1]; // Extract the index from the ID

                    // Trigger AJAX call to get client details
                    $.ajax({
                        url: "{{ url_for('get_client_details') }}",
                        data: { client_name: clientName },
                        success: function(data) {
                            // Update location and phone fields
                            $(`#location_${clientIndex}`).val(data.town);
                            $(`#phone_${clientIndex}`).val(data.phone_number);
                        }
                    });
                }
            });
        }

        // Autocomplete function for team members
        function activateTeamAutocomplete(selector) {
            $(selector).autocomplete({
                source: function(request, response) {
                    let currentVal = $(selector).val();
                    let lastTerm = currentVal.split(',').pop().trim();

                    if (lastTerm.length > 0) {
                        $.getJSON("{{ url_for('autocomplete_member') }}", { term: lastTerm }, response);
                    }
                },
                select: function(event, ui) {
                    let currentVal = $(this).val();
                    let membersArray = currentVal.split(',').map(member => member.trim());
                    membersArray[membersArray.length - 1] = ui.item.value.trim();
                    $(this).val(membersArray.join(', ') + ', ');
                    return false;
                },
                search: function() {
                    let currentVal = $(this).val();
                    let lastTerm = currentVal.split(',').pop().trim();
                    return lastTerm.length > 0;
                }
            });
        }

        // Datepicker with correct format for submission
        $(function() {
            $('#date').datepicker({
                dateFormat: 'yy-mm-dd',
                onSelect: function(dateText) {
                    // Format date for display
                    const selectedDate = new Date(dateText);
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    const formattedDate = selectedDate.toLocaleDateString('en-GB', options);

                    // Add 'st', 'nd', 'rd', or 'th' to the day of the month
                    const day = selectedDate.getDate();
                    const suffix = (day == 1 || day == 21 || day == 31) ? 'st' :
                                   (day == 2 || day == 22) ? 'nd' :
                                   (day == 3 || day == 23) ? 'rd' : 'th';
                    const dayWithSuffix = `${day}${suffix}`;

                    // Replace the day with the formatted day with suffix
                    const formattedDateWithSuffix = formattedDate.replace(/\d+/, dayWithSuffix);

                    // Set the formatted date with suffix in the display field
                    $('#date').val(formattedDateWithSuffix);
                    // Store the date in the correct format for submission
                    $('#date_hidden').val(dateText);
                }
            });
        });
    </script>
</body>
</html>
